<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Show Line-Up Scheduler</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
            color: #333;
        }
        h1 {
            text-align: center;
            color: #2c3e50;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .tab {
            display: none;
        }
        .tab.active {
            display: block;
        }
        .tab-buttons {
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        .tab-btn {
            padding: 12px 24px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            flex: 1;
            min-width: 100px;
        }
        .tab-btn.active {
            background-color: #2980b9;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            padding: 12px;
            border: 1px solid #ddd;
            text-align: left;
        }
        th {
            background-color: #3498db;
            color: white;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        textarea, select, input {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border-radius: 5px;
            border: 1px solid #ddd;
            font-size: 16px;
            min-height: 150px;
        }
        select[multiple] {
            min-height: 200px;
        }
        button {
            padding: 12px 24px;
            background-color: #2ecc71;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px 0;
            width: 100%;
            font-size: 16px;
        }
        button:hover {
            background-color: #27ae60;
        }
        #exportBtn {
            background-color: #e74c3c;
        }
        #exportBtn:hover {
            background-color: #c0392b;
        }
        @media (max-width: 600px) {
            .container { padding: 10px; }
            .tab-btn { padding: 10px; font-size: 14px; }
            th, td { padding: 8px; font-size: 14px; }
            textarea, select, input { font-size: 14px; min-height: 120px; }
            select[multiple] { min-height: 150px; }
            button { padding: 10px; font-size: 14px; }
        }
        #lineup { page-break-inside: avoid; }
        #lineUpTable, #deviationsTable {
            width: 100%;
            max-width: 210mm;
            margin: 0 auto;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>Show Line-Up Scheduler</h1>

        <!-- Tab Buttons -->
        <div class="tab-buttons">
            <button class="tab-btn active" onclick="openTab('artists')">Artists</button>
            <button class="tab-btn" onclick="openTab('roles')">Roles</button>
            <button class="tab-btn" onclick="openTab('conflicts')">Conflicts</button>
            <button class="tab-btn" onclick="openTab('absences')">Absences</button>
            <button class="tab-btn" onclick="openTab('competencies')">Competencies</button>
            <button class="tab-btn" onclick="openTab('lineup')">Line-Up</button>
        </div>

        <!-- Artists Tab -->
        <div id="artists" class="tab active">
            <h2>Artists</h2>
            <p>Add one artist per line: "Name,Gender" (e.g., "John,M")</p>
            <textarea id="artistsInput" placeholder="John,M
Emma,F"></textarea>
            <button onclick="saveData('artists')">Save Artists</button>
        </div>

        <!-- Roles Tab -->
        <div id="roles" class="tab">
            <h2>Roles</h2>
            <p>Add one role per line: "Name,Act" (e.g., "Lead Singer,Act1")</p>
            <textarea id="rolesInput" placeholder="Lead Singer,Act1
Backup Singer,Act1"></textarea>
            <button onclick="saveData('roles')">Save Roles</button>
        </div>

        <!-- Conflicts Tab -->
        <div id="conflicts" class="tab">
            <h2>Conflicts</h2>
            <p>Select a role and list conflicting roles.</p>
            <select id="conflictRole" onchange="loadConflicts()"></select>
            <textarea id="conflictsInput" placeholder="List conflicting roles (e.g., Backup Singer)"></textarea>
            <button onclick="saveConflicts()">Save Conflicts</button>
        </div>

        <!-- Absences Tab -->
        <div id="absences" class="tab">
            <h2>Absences & Specific Assignments</h2>
            <p>Select absent artists:</p>
            <select id="absentArtists" multiple size="10"></select>
            <p>Override: Select a role and the artist taking it over (optional):</p>
            <select id="overrideRole"></select>
            <select id="overrideArtist"></select>
            <p>Specific Assignment: Assign a non-standard role to an artist (takes priority):</p>
            <select id="specificRole"></select>
            <select id="specificArtist"></select>
            <button onclick="saveAbsences()">Save Absences & Assignments</button>
        </div>

        <!-- Competencies Tab -->
        <div id="competencies" class="tab">
            <h2>Competencies</h2>
            <p>Select an artist and assign multiple roles with duo partners if needed.</p>
            <select id="compArtist" onchange="loadCompetency()"></select>
            <select id="compRoles" multiple size="10"></select>
            <select id="compDuo"><option value="">No Duo</option></select>
            <button onclick="saveCompetency()">Save Competency</button>
        </div>

        <!-- Line-Up Tab -->
        <div id="lineup" class="tab">
            <h2>Generated Line-Up</h2>
            <button onclick="generateLineUp()">Generate Line-Up</button>
            <table id="lineUpTable">
                <thead>
                    <tr>
                        <th>Role</th>
                        <th>Act</th>
                        <th>Artist</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="lineUpBody"></tbody>
            </table>
            <h2>Deviations from Standard</h2>
            <table id="deviationsTable">
                <thead>
                    <tr>
                        <th>Role</th>
                        <th>Standard Artist</th>
                        <th>New Artist</th>
                        <th>Reason</th>
                    </tr>
                </thead>
                <tbody id="deviationsBody"></tbody>
            </table>
            <button id="exportBtn" onclick="exportToPNG()">Export to PNG</button>
        </div>
    </div>

    <script>
        // Tab handling
        function openTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            document.querySelector(`button[onclick="openTab('${tabName}')"]`).classList.add('active');
            if (['conflicts', 'absences', 'competencies'].includes(tabName)) loadDropdowns();
        }

        // Load saved data on page load
        window.onload = function() {
            loadData('artists', 'artistsInput');
            loadData('roles', 'rolesInput');
            loadAbsences();
            loadDropdowns();
        };

        // Save data to localStorage
        function saveData(key) {
            const input = document.getElementById(`${key}Input`);
            localStorage.setItem(key, input.value);
            loadDropdowns();
        }

        // Load data from localStorage
        function loadData(key, inputId) {
            const data = localStorage.getItem(key);
            if (data) document.getElementById(inputId).value = data;
        }

        // Parse input text
        function parseInput(text) {
            return text.trim().split('\n').map((line, idx) => [idx + 1, ...line.split(',')]);
        }

        // Load dropdowns
        function loadDropdowns() {
            const artists = parseInput(localStorage.getItem('artists') || '');
            const roles = parseInput(localStorage.getItem('roles') || '');

            // Conflicts
            const conflictRole = document.getElementById('conflictRole');
            conflictRole.innerHTML = roles.map(([id, name]) => `<option value="${name}">${name}</option>`).join('');
            loadConflicts();

            // Absences
            const absentArtists = document.getElementById('absentArtists');
            const overrideRole = document.getElementById('overrideRole');
            const overrideArtist = document.getElementById('overrideArtist');
            const specificRole = document.getElementById('specificRole');
            const specificArtist = document.getElementById('specificArtist');
            absentArtists.innerHTML = artists.map(([id, name]) => `<option value="${name}">${name}</option>`).join('');
            overrideRole.innerHTML = roles.map(([id, name]) => `<option value="${name}">${name}</option>`).join('');
            overrideArtist.innerHTML = artists.map(([id, name]) => `<option value="${name}">${name}</option>`).join('');
            specificRole.innerHTML = roles.map(([id, name]) => `<option value="${name}">${name}</option>`).join('');
            specificArtist.innerHTML = artists.map(([id, name]) => `<option value="${name}">${name}</option>`).join('');

            // Competencies
            const compArtist = document.getElementById('compArtist');
            const compRoles = document.getElementById('compRoles');
            const compDuo = document.getElementById('compDuo');
            compArtist.innerHTML = artists.map(([id, name]) => `<option value="${name}">${name}</option>`).join('');
            compRoles.innerHTML = roles.map(([id, name]) => `<option value="${name}">${name}</option>`).join('');
            compDuo.innerHTML = '<option value="">No Duo</option>' + roles.map(([id, name]) => `<option value="${name}">${name}</option>`).join('');
            loadCompetency();
        }

        // Save and load conflicts
        function saveConflicts() {
            const role = document.getElementById('conflictRole').value;
            const conflicts = document.getElementById('conflictsInput').value.trim().split('\n');
            const allConflicts = JSON.parse(localStorage.getItem('conflicts') || '{}');
            allConflicts[role] = conflicts;
            localStorage.setItem('conflicts', JSON.stringify(allConflicts));
        }

        function loadConflicts() {
            const role = document.getElementById('conflictRole').value;
            const allConflicts = JSON.parse(localStorage.getItem('conflicts') || '{}');
            document.getElementById('conflictsInput').value = (allConflicts[role] || []).join('\n');
        }

        // Save and load absences
        function saveAbsences() {
            const absent = Array.from(document.getElementById('absentArtists').selectedOptions).map(opt => opt.value);
            const overrideRole = document.getElementById('overrideRole').value;
            const overrideArtist = document.getElementById('overrideArtist').value;
            const specificRole = document.getElementById('specificRole').value;
            const specificArtist = document.getElementById('specificArtist').value;
            const absences = {
                absent,
                overrides: overrideRole ? [{ role: overrideRole, artist: overrideArtist }] : [],
                specifics: specificRole ? [{ role: specificRole, artist: specificArtist }] : []
            };
            localStorage.setItem('absences', JSON.stringify(absences));
        }

        function loadAbsences() {
            const data = JSON.parse(localStorage.getItem('absences') || '{}');
            if (data.absent) {
                const absentArtists = document.getElementById('absentArtists');
                data.absent.forEach(val => absentArtists.querySelector(`option[value="${val}"]`).selected = true);
            }
            if (data.overrides?.[0]) {
                document.getElementById('overrideRole').value = data.overrides[0].role;
                document.getElementById('overrideArtist').value = data.overrides[0].artist;
            }
            if (data.specifics?.[0]) {
                document.getElementById('specificRole').value = data.specifics[0].role;
                document.getElementById('specificArtist').value = data.specifics[0].artist;
            }
        }

        // Save and load competencies
        function saveCompetency() {
            const artist = document.getElementById('compArtist').value;
            const roles = Array.from(document.getElementById('compRoles').selectedOptions).map(opt => opt.value);
            const duo = document.getElementById('compDuo').value;
            const allCompetencies = JSON.parse(localStorage.getItem('competencies') || '{}');
            roles.forEach(role => {
                allCompetencies[role] = { artist, duo: duo || '' };
            });
            localStorage.setItem('competencies', JSON.stringify(allCompetencies));
        }

        function loadCompetency() {
            const artist = document.getElementById('compArtist').value;
            const allCompetencies = JSON.parse(localStorage.getItem('competencies') || '{}');
            const compRoles = document.getElementById('compRoles');
            Array.from(compRoles.options).forEach(opt => {
                opt.selected = allCompetencies[opt.value]?.artist === artist;
            });
            const firstRole = Object.keys(allCompetencies).find(r => allCompetencies[r].artist === artist);
            document.getElementById('compDuo').value = allCompetencies[firstRole]?.duo || '';
        }

        // Generate line-up
        function generateLineUp() {
            const artists = parseInput(localStorage.getItem('artists') || '');
            const roles = parseInput(localStorage.getItem('roles') || '');
            const absences = JSON.parse(localStorage.getItem('absences') || '{}');
            const competencies = JSON.parse(localStorage.getItem('competencies') || '{}');
            const conflicts = JSON.parse(localStorage.getItem('conflicts') || '{}');

            const artistDict = {};
            artists.forEach(([id, name, gender]) => {
                artistDict[name] = { gender, absent: absences.absent?.includes(name) || false, roles: [] };
            });

            const roleDict = {};
            roles.forEach(([id, name, act]) => {
                roleDict[name] = { act, conflicts: conflicts[name] || [], ...competencies[name] };
                if (competencies[name]?.artist) artistDict[competencies[name].artist].roles.push(name);
            });

            // Apply specific assignments (highest priority)
            absences.specifics?.forEach(({ role, artist }) => {
                const originalArtist = roleDict[role].artist;
                roleDict[role].artist = artist;
                artistDict[artist].roles.push(role);
                if (originalArtist && originalArtist !== artist) {
                    artistDict[originalArtist].roles = artistDict[originalArtist].roles.filter(r => r !== role);
                }
            });

            // Apply overrides
            absences.overrides?.forEach(({ role, artist }) => {
                const originalArtist = roleDict[role].artist;
                roleDict[role].artist = artist;
                artistDict[artist].roles.push(role);
                if (originalArtist && originalArtist !== artist) {
                    artistDict[originalArtist].roles = artistDict[originalArtist].roles.filter(r => r !== role);
                }
            });

            const lineUpBody = document.getElementById('lineUpBody');
            const deviationsBody = document.getElementById('deviationsBody');
            lineUpBody.innerHTML = '';
            deviationsBody.innerHTML = '';

            Object.keys(roleDict).forEach(role => {
                let artist = roleDict[role].artist;
                let status = 'OK';

                // Handle absence
                if (artistDict[artist]?.absent && !absences.specifics?.some(s => s.role === role && s.artist === artist)) {
                    artist = findReplacement(role, artistDict, roleDict);
                    status = artist ? 'Reassigned (Absent)' : 'No Replacement';
                }

                // Check duo consistency
                if (roleDict[role].duo && roleDict[roleDict[role].duo]?.artist !== artist) {
                    artist = findReplacement(role, artistDict, roleDict, roleDict[role].duo);
                    status = artist ? 'Reassigned (Duo)' : 'Duo Conflict';
                }

                // Check conflicts
                if (roleDict[role].conflicts.some(conflict => roleDict[conflict]?.artist === artist)) {
                    artist = findReplacement(role, artistDict, roleDict);
                    status = artist ? 'Reassigned (Conflict)' : 'Conflict Unresolved';
                }

                // Update role assignment
                if (artist && artist !== roleDict[role].artist) {
                    const oldArtist = roleDict[role].artist;
                    roleDict[role].artist = artist;
                    artistDict[artist].roles.push(role);
                    if (oldArtist) artistDict[oldArtist].roles = artistDict[oldArtist].roles.filter(r => r !== role);
                }

                // Line-up row
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${role}</td>
                    <td>${roleDict[role].act}</td>
                    <td>${artist || 'Unassigned'}</td>
                    <td>${status}</td>
                `;
                lineUpBody.appendChild(row);

                // Deviations row
                const stdArtist = competencies[role]?.artist;
                if (artist !== stdArtist) {
                    const devRow = document.createElement('tr');
                    devRow.innerHTML = `
                        <td>${role}</td>
                        <td>${stdArtist || 'None'}</td>
                        <td>${artist || 'Unassigned'}</td>
                        <td>${status}</td>
                    `;
                    deviationsBody.appendChild(devRow);
                }
            });
        }

        function findReplacement(role, artistDict, roleDict, duoRequirement = null) {
            for (let [aName, aData] of Object.entries(artistDict)) {
                if (!aData.absent && !roleDict[role].conflicts.includes(aName) &&
                    (!duoRequirement || roleDict[duoRequirement]?.artist === aName)) {
                    const canTakeRole = !Object.values(roleDict).some(r => r.artist === aName && r.act === roleDict[role].act && r !== role);
                    if (canTakeRole) return aName;
                }
            }
            return null;
        }

        // Export to PNG
        function exportToPNG() {
            html2canvas(document.getElementById('lineup')).then(canvas => {
                const link = document.createElement('a');
                link.download = 'show_lineup.png';
                link.href = canvas.toDataURL('image/png');
                link.click();
            });
        }
    </script>
</body>
</html>
